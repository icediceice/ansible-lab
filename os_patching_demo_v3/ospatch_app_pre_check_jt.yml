---
- name: "OS Patching : Precheck Process"
  hosts: "{{ app_servers }}"
  #strategy: free
  gather_facts: false
  become: true
  tasks:
    - name: 'Include OS pre-check role'
      ansible.builtin.include_role: 
        name: 'precheck_{{ app_server_os_type }}'

    # - name: 'debug facts'
    #   ansible.builtin.debug: 
    #     var: pre_check_fail | default(false)
    - ansible.builtin.setup:
        filter: ansible_date_time
      register: result
      delegate_to: localhost
      run_once: true

    - ansible.builtin.set_fact:
        datetime: "{{ ansible_date_time.date }}_{{ ansible_date_time.time |  replace(':','-') }}" 
      delegate_to: localhost
      delegate_facts: true
      run_once: true

    - name: debug datetime
      ansible.builtin.debug:
        var: hostvars['localhost'].datetime
      run_once: true

    - name: Save precheck adf json to {{ report_out_dir }}
      delegate_to: localhost
      run_once: true
      template:
        src: templates/os_pre_check_result_adf.j2
        dest: "{{ report_out_dir  }}/os_precheck_app_{{ app_name | default('') }}_adf_json_{{hostvars['localhost'].datetime}}.json"   
      vars:
        report_out_dir: '/opt/ansible/reports/patching'

    - name: 'OS_PRE_CHECK | Fail if there were errors in the pre-checks'
      ansible.builtin.fail: 
        msg: 'OS_PRE_CHECK for {{ inventory_hostname }} has failed. Failed stage: {{ pre_check_fail_stage }}'     
      when: pre_check_fail

    # - name: 'debug facts'
    #   ansible.builtin.debug: 
    #     msg: fact_pre_check 
